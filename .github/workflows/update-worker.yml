åç§°ï¼šè‡ªåŠ¨æ›´æ–°å·¥äºº

åœ¨ï¼š
  æ¨ï¼š
    åˆ†æ”¯ï¼š
      -ä¸»è¦çš„
  æ—¥ç¨‹ï¼š
    - cron: "0 1 * * *"0 1 * * * â€  # æ¯å¤©å‡Œæ™¨1ç‚¹è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:       # æ”¯æŒæ‰‹åŠ¨è¿è¡Œ

è®¸å¯ï¼š
  å†…å®¹ï¼šå†™

å·¥ä½œï¼š
  æ›´æ–°ï¼š
    è¿è¡Œï¼š ubuntu-latest
    æ­¥éª¤ï¼š
      - name: åˆå§‹åŒ–ä»“åº“
        ç”¨é€”ï¼š Action/Checkout@V4

      - name: è·å–å½“å‰æœ¬åœ°ç‰ˆæœ¬
        id ï¼š get_local_version
        è¿è¡Œï¼š|
          å¦‚æœ[-fç‰ˆæœ¬.txt];ç„¶å
            local_version = $ï¼ˆcat version.txtï¼‰
            echo "å½“å‰æœ¬åœ°ç‰ˆæœ¬: $LOCAL_VERSION"
          åˆ«çš„
            echo "é¦–æ¬¡åŒæ­¥ï¼Œæ²¡æœ‰æœ¬åœ°ç‰ˆæœ¬ã€‚"
            local_version =â€œâ€
          fi
          echoâ€œ local_version = $ local_versionâ€ >> $ github_env

      - name: è·å–æœ€æ–° Release ä¿¡æ¯
        id ï¼š get_release
        è¿è¡Œï¼š|
          api_url =â€œ https://api.github.com/repos/bia-pain-bache/bpb-worker-panel/releasesâ€
          å“åº”= $ï¼ˆcurl -sâ€œ $ api_urlâ€ï¼‰
          æœ€æ–°_release = $ï¼ˆechoâ€œ $ wendespâ€ | jq -r'ã€‚[0]'ï¼‰
          tag_name = $ï¼ˆechoâ€œ $æœ€æ–°_releaseâ€ | jq -r'.tag_name'ï¼‰
          download_url = $ï¼ˆechoâ€œ $ festment_releaseâ€ | jq -r'ã€‚assets [] | selectï¼ˆ.name ==â€œ worker.zipâ€ï¼‰| .browser_download_url'ï¼‰

          å¦‚æœ[-zâ€œ $ download_urlâ€] || [â€œ $ download_urlâ€ ==â€œ nullâ€];ç„¶å
            echo "æœªæ‰¾åˆ° worker.zipï¼Œé€€å‡ºï¼"
            å‡ºå£1
          fi

          echo "æœ€æ–°ç‰ˆæœ¬å·: $TAG_NAME"
          echoâ€œ download_url = $ download_urlâ€ >> $ github_env
          echoâ€œ tag_name = $ tag_nameâ€ >> $ github_env

      - name: åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°
        id ï¼š check_update
        è¿è¡Œï¼š|
          å¦‚æœ[â€œ $ local_versionâ€ =â€œ $ tag_nameâ€];ç„¶å
            echo "å·²ç»æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°ã€‚"
            echoâ€œ update_needed = falseâ€ >> $ github_env
          åˆ«çš„
            echo "å‘ç°æ–°ç‰ˆæœ¬ï¼Œéœ€è¦æ›´æ–°ï¼"
            echoâ€œ update_needed = trueâ€ >> $ github_env
          fi

      - name: å¦‚æœéœ€è¦ï¼Œæ¸…ç†æ—§æ–‡ä»¶å¹¶ä¸‹è½½æ–°ç‰ˆæœ¬
        å¦‚æœï¼š env.update_needed == 'true'
        è¿è¡Œï¼š|
          rm -rf ./*
          wget -o worker.zipâ€œ $ download_urlâ€
          UNZIP WORKER.ZIP
          RM Worker.zip
          echoâ€œ $ tag_nameâ€> version.txt

      - name: æäº¤æ›´æ”¹
        å¦‚æœï¼š env.update_needed == 'true'
        ç”¨é€”ï¼š Stefanzweifel/git-auto-commit-action@v5
        å’Œï¼š
          commit_message: "ğŸ”„ è‡ªåŠ¨åŒæ­¥æœ€æ–° Worker ç‰ˆæœ¬ï¼š${{ env.TAG_NAME }}"
          commit_author ï¼šâ€œ github-actions [bot] <github-actions [bot]@users.noreply.github.com>>â€œ
          push_options ï¼š -force
